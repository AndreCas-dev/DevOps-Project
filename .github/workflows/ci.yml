name: CI Pipeline

on:
  push:
    branches: [dev]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  # ===========================================
  # UNIT TESTS
  # ===========================================
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './docker/backend/package-lock.json'

      - name: Install dependencies
        working-directory: ./docker/backend
        run: npm ci

      - name: Build TypeScript
        working-directory: ./docker/backend
        run: npm run build

      - name: Run tests
        working-directory: ./docker/backend
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        run: npm test

  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './docker/frontend/package-lock.json'

      - name: Install dependencies
        working-directory: ./docker/frontend
        run: npm ci

      - name: Build
        working-directory: ./docker/frontend
        run: npm run build

      - name: Run tests
        working-directory: ./docker/frontend
        run: npm test

  # ===========================================
  # SECURITY
  # ===========================================
  security-gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: false
          GITLEAKS_ARTIFACT_NAME: gitleaks-report-initial
          GITLEAKS_CONFIG: ci-cd/security/gitleaks.toml

  security-trivy:
    name: Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'

  # ===========================================
  # BUILD, E2E TEST, AND PUSH
  # ===========================================
  build-test-push:
    name: Build, E2E Test & Push
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, security-gitleaks, security-trivy]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build images locally first
      - name: Build Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/backend
          file: ./docker/backend/Dockerfile
          load: true
          tags: backend:test
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/frontend
          file: ./docker/frontend/Dockerfile
          load: true
          tags: frontend:test
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      # Run E2E tests with built images
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './tests/e2e/package-lock.json'

      - name: Install E2E dependencies
        working-directory: ./tests/e2e
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./tests/e2e
        run: npx playwright install --with-deps chromium

      - name: Create .env file
        run: |
          mkdir -p secrets
          cat > secrets/.env << EOF
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=Test
          PORT=8000
          DEBUG=false
          NGINX_PORT=80
          GF_ADMIN_USER=admin
          GF_ADMIN_PASSWORD=admin
          GF_SECURITY_ADMIN_USER=admin
          GF_SECURITY_ADMIN_PASSWORD=admin
          PGADMIN_EMAIL=admin@admin.com
          PGADMIN_PASSWORD=admin
          EOF

      - name: Start application stack
        working-directory: ./docker
        run: |
          docker compose -f docker-compose.ci.yml up -d
          sleep 30

      - name: Wait for services to be ready
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost/health; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 5
          done

      - name: Run E2E tests
        working-directory: ./tests/e2e
        env:
          APP_URL: http://localhost
          API_URL: http://localhost/api
        run: npx playwright test

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 7

      - name: Show container logs on failure
        if: failure()
        working-directory: ./docker
        run: docker compose -f docker-compose.ci.yml logs

      - name: Stop application stack
        if: always()
        working-directory: ./docker
        run: docker compose -f docker-compose.ci.yml down -v

      # Push images only if E2E tests passed
      - name: Set lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.IMAGE_NAME }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}/backend
          tags: |
            type=ref,event=branch
            type=sha,prefix=

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}/frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix=

      - name: Push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/backend
          file: ./docker/backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha,scope=backend

      - name: Push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/frontend
          file: ./docker/frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha,scope=frontend

  # ===========================================
  # DEPLOY TO TEST ENVIRONMENT
  # ===========================================
  deploy-test:
    name: Deploy to Test Environment
    runs-on: self-hosted
    needs: [build-test-push]
    environment: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create test environment .env file
        run: |
          mkdir -p secrets
          cat > secrets/.env.test << EOF
          POSTGRES_HOST=${{ secrets.TEST_DB_HOST }}
          POSTGRES_PORT=5432
          POSTGRES_USER=${{ secrets.TEST_POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.TEST_POSTGRES_PASSWORD }}
          POSTGRES_DB=test_manual_db
          PORT=8000
          DEBUG=true
          EOF

      - name: Set lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.IMAGE_NAME }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Generate pgAdmin server config
        run: |
          cat > docker/pgadmin/servers-test.json << EOF
          {
            "Servers": {
              "1": {
                "Name": "Test Database",
                "Group": "Test Environment",
                "Host": "${{ secrets.TEST_DB_HOST }}",
                "Port": 5432,
                "MaintenanceDB": "test_manual_db",
                "Username": "${{ secrets.TEST_POSTGRES_USER }}",
                "SSLMode": "prefer"
              }
            }
          }
          EOF

      - name: Deploy to Test Environment
        working-directory: ./docker
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ steps.image.outputs.name }}
          IMAGE_TAG: ${{ github.ref_name }}
          POSTGRES_HOST: ${{ secrets.TEST_DB_HOST }}
          POSTGRES_PORT: 5432
          POSTGRES_USER: ${{ secrets.TEST_POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.TEST_POSTGRES_PASSWORD }}
          POSTGRES_DB: test_manual_db
          TEST_PORT: 8080
        run: |
          docker compose -f docker-compose.test.yml pull
          docker compose -f docker-compose.test.yml up -d --force-recreate
          sleep 30

      - name: Health check Test Environment
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8080/health; then
              echo "Test environment is ready!"
              break
            fi
            echo "Waiting for test environment... ($i/30)"
            sleep 5
          done

      - name: Display Test Environment URL
        run: |
          echo "=========================================="
          echo "TEST ENVIRONMENT READY FOR MANUAL TESTING"
          echo "=========================================="
          echo "App URL: http://${{ secrets.TEST_SERVER_HOST }}:8080"
          echo "pgAdmin: http://${{ secrets.TEST_SERVER_HOST }}:8080/pgadmin"
          echo ""
          echo "Database (External VM):"
          echo "  Host: ${{ secrets.TEST_DB_HOST }}"
          echo "  Database: test_manual_db"
          echo ""
          echo "Please perform manual testing and approve"
          echo "the 'manual-approval' job when ready to proceed."
          echo "=========================================="

  # ===========================================
  # MANUAL APPROVAL GATE
  # ===========================================
  manual-approval:
    name: Manual Testing Approval
    runs-on: ubuntu-latest
    needs: [deploy-test]
    environment: manual-testing

    steps:
      - name: Approval checkpoint
        run: |
          echo "=========================================="
          echo "MANUAL TESTING APPROVED"
          echo "=========================================="
          echo "Developer has completed manual testing."
          echo "Proceeding with final tests and merge..."
          echo "=========================================="

  # ===========================================
  # POST-APPROVAL: RE-RUN ALL TESTS
  # ===========================================
  post-approval-backend-tests:
    name: Post-Approval Backend Tests
    runs-on: ubuntu-latest
    needs: [manual-approval]

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './docker/backend/package-lock.json'

      - name: Install dependencies
        working-directory: ./docker/backend
        run: npm ci

      - name: Build TypeScript
        working-directory: ./docker/backend
        run: npm run build

      - name: Run tests
        working-directory: ./docker/backend
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        run: npm test

  post-approval-frontend-tests:
    name: Post-Approval Frontend Tests
    runs-on: ubuntu-latest
    needs: [manual-approval]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './docker/frontend/package-lock.json'

      - name: Install dependencies
        working-directory: ./docker/frontend
        run: npm ci

      - name: Build
        working-directory: ./docker/frontend
        run: npm run build

      - name: Run tests
        working-directory: ./docker/frontend
        run: npm test

  post-approval-security-gitleaks:
    name: Post-Approval Secret Detection
    runs-on: ubuntu-latest
    needs: [manual-approval]
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          wget -qO- https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: gitleaks detect --source . --config ci-cd/security/gitleaks.toml --verbose

  post-approval-security-trivy:
    name: Post-Approval Vulnerability Scan
    runs-on: ubuntu-latest
    needs: [manual-approval]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'

  post-approval-e2e-tests:
    name: Post-Approval E2E Tests
    runs-on: ubuntu-latest
    needs: [manual-approval]
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.IMAGE_NAME }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Pull images from registry
        run: |
          docker pull ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}/backend:${{ github.ref_name }}
          docker pull ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}/frontend:${{ github.ref_name }}
          docker tag ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}/backend:${{ github.ref_name }} backend:test
          docker tag ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}/frontend:${{ github.ref_name }} frontend:test

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './tests/e2e/package-lock.json'

      - name: Install E2E dependencies
        working-directory: ./tests/e2e
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./tests/e2e
        run: npx playwright install --with-deps chromium

      - name: Create .env file
        run: |
          mkdir -p secrets
          cat > secrets/.env << EOF
          POSTGRES_HOST=db
          POSTGRES_PORT=5432
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=Test
          PORT=8000
          DEBUG=false
          EOF

      - name: Start application stack
        working-directory: ./docker
        run: |
          docker compose -f docker-compose.ci.yml up -d
          sleep 30

      - name: Wait for services to be ready
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost/health; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 5
          done

      - name: Run E2E tests
        working-directory: ./tests/e2e
        env:
          APP_URL: http://localhost
          API_URL: http://localhost/api
        run: npx playwright test

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-post-approval
          path: tests/e2e/playwright-report/
          retention-days: 7

      - name: Show container logs on failure
        if: failure()
        working-directory: ./docker
        run: docker compose -f docker-compose.ci.yml logs

      - name: Stop application stack
        if: always()
        working-directory: ./docker
        run: docker compose -f docker-compose.ci.yml down -v

  # ===========================================
  # CLEANUP TEST ENVIRONMENT
  # ===========================================
  cleanup-test:
    name: Cleanup Test Environment
    runs-on: self-hosted
    needs: [post-approval-backend-tests, post-approval-frontend-tests, post-approval-security-gitleaks, post-approval-security-trivy, post-approval-e2e-tests]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Stop Test Environment
        working-directory: ./docker
        run: |
          docker compose -f docker-compose.test.yml down -v || true
          echo "Test environment cleaned up"

  # ===========================================
  # MERGE TO MAIN
  # ===========================================
  merge-to-main:
    name: Merge to Main
    runs-on: ubuntu-latest
    needs: [post-approval-backend-tests, post-approval-frontend-tests, post-approval-security-gitleaks, post-approval-security-trivy, post-approval-e2e-tests]
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge dev to main
        run: |
          git checkout main
          git merge origin/dev --no-ff -m "CI: Merge dev to main [skip ci]"
          git push origin main
