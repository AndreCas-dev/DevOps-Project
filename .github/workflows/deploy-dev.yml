name: Deploy to Development

on:
  push:
    branches: [dev]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy'
        required: false
        default: false
        type: boolean

env:
  ENVIRONMENT: development
  ANSIBLE_HOST_KEY_CHECKING: 'false'

jobs:
  test:
    name: Run Tests
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    uses: ./.github/workflows/test.yml

  build:
    name: Build Images
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    uses: ./.github/workflows/build.yml

  deploy:
    name: Deploy to Dev Server
    needs: [build]
    if: always() && needs.build.result == 'success'
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # - name: Install Ansible
      #   run: |
      #     pip install ansible ansible-core
      #     ansible-galaxy collection install community.docker community.general

      - name: Create inventory file
        run: |
          cat > inventory.ini << EOF
          [webservers]
          dev-server ansible_host=${{ secrets.DEV_SERVER_HOST }} ansible_user=${{ secrets.DEV_SSH_USER }} ansible_connection=local
          EOF

      - name: Deploy with Ansible
        working-directory: ./infrastructure/ansible
        env:
          ANSIBLE_CONFIG: ./ansible.cfg
        run: |
          ansible-playbook \
            -i ../../inventory.ini \
            playbooks/deploy-app.yml \
            -e "environment=development" \
            -e "pull_images=true" \
            -e "build_images=false" \
            -v

      - name: Health check
        run: |
          sleep 30
          curl -f http://localhost/health || exit 1
          echo "Health check passed!"

      - name: Notify on success
        if: success()
        run: echo "Deployment to development successful!"

      - name: Notify on failure
        if: failure()
        run: echo "Deployment to development failed!"
