name: Deploy to Development

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy'
        required: false
        default: 'false'
        type: boolean

env:
  ENVIRONMENT: development
  ANSIBLE_HOST_KEY_CHECKING: 'false'

jobs:
  test:
    name: Run Tests
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    uses: ./.github/workflows/test.yml

  build:
    name: Build Images
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    uses: ./.github/workflows/build.yml

  deploy:
    name: Deploy to Dev Server
    needs: [build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible ansible-core
          ansible-galaxy collection install community.docker community.general

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create inventory file
        run: |
          cat > inventory.ini << EOF
          [webservers]
          dev-server ansible_host=${{ secrets.DEV_SERVER_HOST }} ansible_user=${{ secrets.DEV_SSH_USER }}
          EOF

      - name: Deploy with Ansible
        working-directory: ./infrastructure/ansible
        env:
          ANSIBLE_CONFIG: ./ansible.cfg
        run: |
          ansible-playbook \
            -i ../../inventory.ini \
            playbooks/deploy-app.yml \
            -e "environment=development" \
            -e "pull_images=true" \
            -e "build_images=false" \
            -v

      - name: Health check
        run: |
          sleep 30
          curl -f http://${{ secrets.DEV_SERVER_HOST }}/health || exit 1
          echo "Health check passed!"

      - name: Notify on success
        if: success()
        run: echo "Deployment to development successful!"

      - name: Notify on failure
        if: failure()
        run: echo "Deployment to development failed!"
