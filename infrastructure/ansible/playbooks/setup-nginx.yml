---
# Playbook: Setup Nginx
# Description: Deploy and configure Nginx as reverse proxy
# Usage: ./run-playbook.sh -e production -p playbooks/setup-nginx.yml

- name: Setup Nginx Reverse Proxy
  hosts: all
  become: true
  gather_facts: true

  vars_files:
    - ../group_vars/all.yml

  pre_tasks:
    - name: Display nginx setup information
      ansible.builtin.debug:
        msg: |
          ========================================
          Nginx Setup Starting
          ========================================
          Target: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Environment: {{ environment | default('production') }}
          ========================================

    - name: Verify Docker is running
      ansible.builtin.command: docker info
      register: docker_info
      changed_when: false
      failed_when: docker_info.rc != 0

  roles:
    - role: nginx
      tags: [nginx]

  post_tasks:
    - name: Get nginx service status
      ansible.builtin.shell: |
        echo "=== Nginx Status ===" && \
        docker ps --filter "name=nginx" --format "table {% raw %}{{.Names}}\t{{.Status}}{% endraw %}" 2>/dev/null || echo "Nginx not running"
      register: nginx_status
      changed_when: false
      ignore_errors: true

    - name: Display nginx status
      ansible.builtin.debug:
        msg: "{{ nginx_status.stdout_lines }}"
      when: nginx_status.stdout_lines is defined

    - name: Nginx setup completed
      ansible.builtin.debug:
        msg: |
          ========================================
          Nginx Setup Completed!
          ========================================
          Host: {{ inventory_hostname }}

          Access URL: http://{{ ansible_host | default('localhost') }}
          ========================================
