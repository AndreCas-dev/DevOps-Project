---
# PostgreSQL Installation and Configuration
# Supports Ubuntu/Debian and CentOS/RHEL

- name: Include OS-specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution | lower }}.yml"
    - "{{ ansible_os_family | lower }}.yml"
    - "default.yml"

# ============================================
# Add PostgreSQL Official Repository
# ============================================
- name: Install prerequisites (Debian/Ubuntu)
  apt:
    name:
      - wget
      - gnupg2
      - lsb-release
      - acl
      - python3-psycopg2
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

- name: Add PostgreSQL APT key (Debian/Ubuntu)
  apt_key:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    state: present
  when: ansible_os_family == "Debian"

- name: Add PostgreSQL APT repository (Debian/Ubuntu)
  apt_repository:
    repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
    state: present
    filename: pgdg
  when: ansible_os_family == "Debian"

# ============================================
# Installation
# ============================================
- name: Install PostgreSQL (Debian/Ubuntu)
  apt:
    name:
      - postgresql-{{ postgresql_version }}
      - postgresql-contrib-{{ postgresql_version }}
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

# ============================================
# Configuration
# ============================================
- name: Configure PostgreSQL - postgresql.conf
  template:
    src: postgresql.conf.j2
    dest: "{{ postgresql_config_path }}/postgresql.conf"
    owner: postgres
    group: postgres
    mode: '0644'
  notify: Restart PostgreSQL

- name: Configure PostgreSQL - pg_hba.conf
  template:
    src: pg_hba.conf.j2
    dest: "{{ postgresql_config_path }}/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: '0640'
  notify: Restart PostgreSQL

# ============================================
# Service Management
# ============================================
- name: Ensure PostgreSQL is started and enabled
  systemd:
    name: "{{ postgresql_service_name }}"
    state: started
    enabled: yes

- name: Wait for PostgreSQL to be ready
  wait_for:
    port: "{{ postgresql_port }}"
    host: 127.0.0.1
    delay: 5
    timeout: 60

# ============================================
# Database and User Setup
# ============================================
- name: Create PostgreSQL users
  become: true
  become_user: postgres
  postgresql_user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    role_attr_flags: "{{ item.role_attr_flags | default('CREATEDB,LOGIN') }}"
    state: present
  loop: "{{ postgresql_users }}"
  no_log: true

- name: Create PostgreSQL databases
  become: true
  become_user: postgres
  postgresql_db:
    name: "{{ item.name }}"
    owner: "{{ item.owner | default('postgres') }}"
    encoding: "{{ item.encoding | default('UTF8') }}"
    state: present
  loop: "{{ postgresql_databases }}"

- name: Grant database privileges
  become: true
  become_user: postgres
  postgresql_privs:
    database: "{{ item.database }}"
    roles: "{{ item.user }}"
    type: database
    privs: ALL
    state: present
  loop: "{{ postgresql_privileges }}"
  when: postgresql_privileges is defined

# ============================================
# Firewall
# ============================================
- name: Open PostgreSQL port in firewall (UFW)
  ufw:
    rule: allow
    port: "{{ postgresql_port }}"
    proto: tcp
    from_ip: "{{ item }}"
  loop: "{{ postgresql_allowed_hosts }}"
  when: ansible_os_family == "Debian" and postgresql_open_firewall

- name: Open PostgreSQL port in firewall (firewalld)
  firewalld:
    port: "{{ postgresql_port }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes
  when: ansible_os_family == "RedHat" and postgresql_open_firewall
