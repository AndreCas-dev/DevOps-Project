---
# Deploy role tasks

- name: Include variables
  ansible.builtin.include_vars: main.yml

# =============================================================================
# Prepare directories
# =============================================================================
- name: Create application directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  loop:
    - "{{ app_base_dir }}"
    - "{{ app_docker_dir }}"
    - "{{ app_monitoring_dir }}"
    - "{{ app_logging_dir }}"
    - "{{ app_secrets_dir }}"
    - "{{ app_volumes_dir }}"
  become: true

# =============================================================================
# Sync project files
# =============================================================================
- name: Copy docker directory
  ansible.builtin.copy:
    src: "{{ project_root }}/docker/"
    dest: /opt/devops-app/docker/
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: preserve
  become: true
  notify: Restart application

- name: Copy monitoring directory
  ansible.builtin.copy:
    src: "{{ project_root }}/monitoring/"
    dest: /opt/devops-app/monitoring/
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: preserve
  become: true

# Template alertmanager config with Slack webhook URL
- name: Template Alertmanager configuration
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../roles/monitoring/templates/alertmanager.yml.j2"
    dest: "{{ app_monitoring_dir }}/alertmanager/alertmanager.yml"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0644'
  become: true
  vars:
    slack_webhook_url: "{{ monitoring_slack_webhook_url | default('') }}"
    slack_channel: "{{ monitoring_slack_channel | default('#alerts') }}"

- name: Copy logging directory
  ansible.builtin.copy:
    src: "{{ project_root }}/logging/"
    dest: /opt/devops-app/logging/
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: preserve
  become: true

# =============================================================================
# Create volume directories with correct permissions
# =============================================================================
- name: Create Prometheus data directory
  ansible.builtin.file:
    path: "{{ app_volumes_dir }}/prometheus-data"
    state: directory
    owner: "65534"
    group: "65534"
    mode: '0755'
  become: true

- name: Create Grafana data directory
  ansible.builtin.file:
    path: "{{ app_volumes_dir }}/grafana-data"
    state: directory
    owner: "472"
    group: "472"
    mode: '0755'
  become: true

- name: Create Alertmanager data directory
  ansible.builtin.file:
    path: "{{ app_volumes_dir }}/alertmanager-data"
    state: directory
    owner: "65534"
    group: "65534"
    mode: '0755'
  become: true

- name: Create Loki data directory with subdirectories
  ansible.builtin.file:
    path: "{{ app_volumes_dir }}/loki-data/{{ item }}"
    state: directory
    owner: "10001"
    group: "10001"
    mode: '0755'
  loop:
    - ""
    - chunks
    - rules
  become: true

# =============================================================================
# Deploy environment file
# =============================================================================
- name: Debug - Show template variables
  ansible.builtin.debug:
    msg: |
      database: {{ database | default('NOT DEFINED') }}
      app: {{ app | default('NOT DEFINED') }}
      nginx: {{ nginx | default('NOT DEFINED') }}
      monitoring: {{ monitoring | default('NOT DEFINED') }}
      pgadmin: {{ pgadmin | default('NOT DEFINED') }}

- name: Deploy environment file
  ansible.builtin.template:
    src: env.j2
    dest: "{{ app_secrets_dir }}/.env"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0600'
  become: true
  # no_log: true  # Temporarily disabled for debugging

# =============================================================================
# Deploy with Docker Compose
# =============================================================================
- name: Stop and remove existing containers
  community.docker.docker_compose_v2:
    project_src: "{{ app_docker_dir }}"
    project_name: "{{ compose_project_name }}"
    files:
      - "{{ compose_file }}"
      - "{{ compose_override_file }}"
    state: absent
    remove_orphans: true
  become: true
  ignore_errors: true

- name: Force remove conflicting containers
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
    force_kill: true
  loop:
    - alertmanager
    - prometheus
    - grafana
    - loki
    - nginx
    - app
    - frontend
    - db
    - pgadmin
    - node-exporter
    - nginx-exporter
    - postgres-exporter
    - fluent-bit
  become: true
  ignore_errors: true

- name: Pull Docker images
  community.docker.docker_compose_v2:
    project_src: "{{ app_docker_dir }}"
    project_name: "{{ compose_project_name }}"
    files:
      - "{{ compose_file }}"
      - "{{ compose_override_file }}"
    state: present
    pull: always
  become: true
  when: pull_images

- name: Build and deploy application
  community.docker.docker_compose_v2:
    project_src: "{{ app_docker_dir }}"
    project_name: "{{ compose_project_name }}"
    files:
      - "{{ compose_file }}"
      - "{{ compose_override_file }}"
    state: present
    build: "{{ 'always' if build_images else 'never' }}"
    remove_orphans: "{{ remove_orphans }}"
    recreate: "{{ 'always' if force_recreate else 'auto' }}"
    services: "{{ deploy_services if deploy_services | length > 0 else omit }}"
  become: true
  register: deploy_result

- name: Display deployment result
  ansible.builtin.debug:
    msg: |
      Deployment completed!
      Changed: {{ deploy_result.changed }}

# =============================================================================
# Health checks
# =============================================================================
- name: Wait for services to be healthy
  ansible.builtin.uri:
    url: "http://localhost:{{ nginx_port | default(80) }}"
    method: GET
    status_code: [200, 301, 302]
  register: health_check
  retries: 10
  delay: 5
  until: health_check.status in [200, 301, 302]
  ignore_errors: true

- name: Display health check result
  ansible.builtin.debug:
    msg: "Application is {{ 'healthy' if health_check.status is defined and health_check.status in [200, 301, 302] else 'not responding yet' }}"
