---
# Docker installation tasks for Ubuntu/Debian

- name: Include variables
  ansible.builtin.include_vars: main.yml

# Clean up any broken Docker repository first
- name: Remove broken Docker GPG key if exists
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/keyrings/docker.asc
    - /etc/apt/keyrings/docker.gpg
    - /usr/share/keyrings/docker-archive-keyring.gpg
  become: true
  ignore_errors: true

- name: Remove broken Docker repository if exists
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/sources.list.d/docker.sources
  become: true
  ignore_errors: true

- name: Remove Docker entries from sources.list
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list
    regexp: '.*download\.docker\.com.*'
    state: absent
  become: true
  ignore_errors: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true
  ignore_errors: true

- name: Install required packages for Docker
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - python3-pip
      - python3-setuptools
    state: present
  become: true

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Add Docker GPG key
  ansible.builtin.shell: |
    curl -fsSL {{ docker_apt_gpg_key }} -o /etc/apt/keyrings/docker.asc
    chmod 644 /etc/apt/keyrings/docker.asc
  become: true
  args:
    creates: /etc/apt/keyrings/docker.asc

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: "{{ docker_apt_repository }}"
    state: present
    filename: docker
  become: true

- name: Update apt cache after adding Docker repo
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install Docker packages
  ansible.builtin.apt:
    name: "{{ docker_packages }}"
    state: present
  become: true
  notify: Restart Docker

- name: Ensure Docker service is started and enabled
  ansible.builtin.systemd:
    name: docker
    state: "{{ docker_service_state }}"
    enabled: "{{ docker_service_enabled }}"
  become: true

- name: Create docker group
  ansible.builtin.group:
    name: docker
    state: present
  become: true

- name: Add users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ docker_users }}"
  become: true
  when: docker_users | length > 0

- name: Create Docker daemon configuration directory
  ansible.builtin.file:
    path: /etc/docker
    state: directory
    mode: '0755'
  become: true

- name: Configure Docker daemon
  ansible.builtin.template:
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    mode: '0644'
  become: true
  notify: Restart Docker
  when: docker_daemon_options is defined
  
- name: Verify Docker installation
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false

- name: Display Docker version
  ansible.builtin.debug:
    msg: "Docker version: {{ docker_version.stdout }}"

- name: Verify Docker Compose installation
  ansible.builtin.command: docker compose version
  register: docker_compose_version
  changed_when: false

- name: Display Docker Compose version
  ansible.builtin.debug:
    msg: "Docker Compose version: {{ docker_compose_version.stdout }}"
